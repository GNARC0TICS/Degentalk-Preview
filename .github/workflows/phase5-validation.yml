name: ðŸ”¥ Phase 5 Quality Gates

on:
  push:
    branches: [main, develop, 'maintenance/**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # Job 1: Phase 5 Validation Suite
  phase5-validation:
    name: ðŸ›¡ï¸ Phase 5 Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ”§ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Run Phase 5 validation suite
        run: pnpm phase5:validate --detailed

      - name: ðŸ“Š Generate quality metrics
        run: pnpm phase5:validate --metrics
        continue-on-error: true

  # Job 2: Zero-Warning Enforcement
  zero-warnings:
    name: âš ï¸ Zero Warnings Policy
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ”§ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸš¨ ESLint with zero warnings (changed files only)
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Only lint changed files in PRs
            git fetch origin ${{ github.base_ref }}
            changed_files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx)$' || true)
            if [ -n "$changed_files" ]; then
              echo "Linting changed files: $changed_files"
              echo "$changed_files" | xargs pnpm lint --max-warnings 0 --cache
            else
              echo "No TypeScript files changed"
            fi
          else
            # Lint all files on push to main/develop
            pnpm lint --max-warnings 0 --cache
          fi

      - name: ðŸ” TypeScript strict check
        run: pnpm typecheck

  # Job 3: Technical Debt Detection
  debt-detection:
    name: ðŸ•µï¸ Technical Debt Detection
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Check for console usage
        run: |
          if grep -r "console\." server/ --include="*.ts" | grep -v ".test.ts" | grep -v "logger.ts"; then
            echo "âŒ Found console usage in server code"
            exit 1
          else
            echo "âœ… No console usage found"
          fi

      - name: ðŸ” Check for req.user direct access
        run: |
          if grep -r "req\.user" server/ --include="*.ts" | grep -v ".test.ts"; then
            echo "âŒ Found req.user direct access"
            exit 1
          else
            echo "âœ… No req.user direct access found"
          fi

      - name: ðŸ” Check for numeric ID types
        run: |
          violations=0
          for pattern in "userId: number" "threadId: number" "postId: number" "walletId: number"; do
            if grep -r "$pattern" server/ --include="*.ts" | grep -v ".test.ts" | grep -v "scripts/db/utils/"; then
              violations=$((violations + 1))
            fi
          done
          if [ $violations -gt 0 ]; then
            echo "âŒ Found $violations numeric ID type patterns"
            exit 1
          else
            echo "âœ… No numeric ID types found (scripts/db/utils/ whitelisted)"
          fi

  # Job 4: Build and Test
  build-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [zero-warnings] # Only run if warnings check passes

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ”§ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build all packages
        run: pnpm build

      - name: ðŸ§ª Run unit tests
        run: pnpm test:unit
        continue-on-error: true # Don't fail CI on test failures yet

      - name: ðŸ“ˆ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-outputs
          path: |
            client/dist/
            server/dist/
          retention-days: 7

  # Job 5: Import Boundary Enforcement
  boundary-check:
    name: ðŸš§ Import Boundaries
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Check server->client imports
        run: |
          if grep -r "from.*client/" server/ --include="*.ts" | grep -v ".test.ts"; then
            echo "âŒ Server files importing from client/"
            exit 1
          fi

      - name: ðŸ” Check client->server imports
        run: |
          if grep -r "from.*server/" client/ --include="*.ts" | grep -v ".test.ts"; then
            echo "âŒ Client files importing from server/"
            exit 1
          fi

      - name: ðŸ” Check shared boundary violations
        run: |
          if grep -r "from.*\(client\|server\)/" shared/ --include="*.ts"; then
            echo "âŒ Shared files importing from client/ or server/"
            exit 1
          fi

  # Job 6: Transformer Coverage Check
  transformer-coverage:
    name: ðŸ”„ Transformer Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ”§ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Run transformer enforcement audit
        run: pnpm codemod:transformers --detailed
        continue-on-error: true # Generate report but don't fail CI

  # Job 7: Performance & Security
  performance-security:
    name: âš¡ Performance & Security
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [phase5-validation]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ”§ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Security audit
        run: |
          echo "ðŸ” Running security audit..."
          pnpm audit --audit-level=moderate || true

          echo "ðŸ” Checking for high/critical vulnerabilities..."
          if pnpm audit --audit-level=high --parseable | grep -q .; then
            echo "âŒ High/critical vulnerabilities found!"
            pnpm audit --audit-level=high
            exit 1
          else
            echo "âœ… No critical vulnerabilities found"
          fi

      - name: âš¡ Bundle size check
        run: |
          pnpm build
          echo "ðŸ“¦ Bundle sizes:"
          du -sh client/dist/* || echo "No client build output"

  # Job 8: Documentation and Reporting
  documentation:
    name: ðŸ“š Documentation Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for changed files

      - name: ðŸ” Check for documentation updates
        run: |
          # Get changed files
          changed_files=$(git diff --name-only origin/main...HEAD)

          # Check if significant changes require documentation updates
          significant_changes=false

          if echo "$changed_files" | grep -E "(transformer|codemod|phase5)" > /dev/null; then
            significant_changes=true
          fi

          if echo "$changed_files" | grep -E "\.routes\.|\.controller\." > /dev/null; then
            significant_changes=true
          fi

          if [ "$significant_changes" = true ]; then
            echo "ðŸ“ Significant changes detected"
            if ! echo "$changed_files" | grep -E "\.(md|rst|txt)$" > /dev/null; then
              echo "âš ï¸  Consider updating documentation for these changes"
              echo "ðŸ’¡ Changed files suggest API or architecture changes"
            else
              echo "âœ… Documentation files found in changes"
            fi
          else
            echo "âœ… No significant changes requiring documentation"
          fi

  # Job 9: Deployment Readiness (main branch only)
  deployment-readiness:
    name: ðŸš€ Deployment Readiness
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [phase5-validation, zero-warnings, build-test, boundary-check]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ”§ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸš€ Full validation for deployment
        run: |
          echo "ðŸ—ï¸ Testing build process..."
          pnpm build

          echo "ðŸ” Final Phase 5 validation..."
          pnpm phase5:validate

          echo "ðŸ“Š Generating deployment metrics..."
          pnpm phase5:validate --metrics

      - name: ðŸ“Š Generate deployment summary
        run: |
          echo "## ðŸš€ Phase 5 Deployment Readiness Report" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **All Phase 5 validations passed**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Zero warnings policy enforced**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Technical debt patterns eliminated**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Import boundaries enforced**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Build process successful**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **READY FOR DEPLOYMENT!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Phase 5 Quality Standards:" >> $GITHUB_STEP_SUMMARY
          echo "- No console.log in production code" >> $GITHUB_STEP_SUMMARY
          echo "- No req.user direct access" >> $GITHUB_STEP_SUMMARY
          echo "- All responses use transformers" >> $GITHUB_STEP_SUMMARY
          echo "- Zero ESLint warnings" >> $GITHUB_STEP_SUMMARY
          echo "- Full TypeScript compliance" >> $GITHUB_STEP_SUMMARY
