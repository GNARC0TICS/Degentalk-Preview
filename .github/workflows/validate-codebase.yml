name: ðŸš€ Degentalk Codebase Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # Allow manual triggering

jobs:
  # Job 1: Quick CI Environment Sanity Check
  ci-env-check: # Was 'validate-everything' job, but runs 'npm run check'
    name: âš™ï¸ CI Environment Sanity Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - name: ðŸ”§ Install dependencies
        run: npm ci
      - name: ðŸš€ Run CI readiness checks
        run: npm run check # This is scripts/test-ci-readiness.ts

  # Job 2: Core Codebase Validations
  core-validation: # Was 'validate-boundaries', but now more focused
    name: ðŸ›¡ï¸ Core Codebase Validation
    runs-on: ubuntu-latest
    needs: ci-env-check # Make sure env is okay first
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - name: ðŸ”§ Install dependencies
        run: npm ci
      - name: ðŸ” Run comprehensive validation suite
        run: npm run validate # This is scripts/validate-everything.ts
      # The explicit 'tsc --noEmit', 'grep vite.config', and schema export count
      # steps are removed from here as they are inside 'npm run validate'

  # Job 3: Formatting Check (Prettier)
  formatting-check: # Was 'lint-and-format'
    name: ðŸŽ¨ Code Formatting Check
    runs-on: ubuntu-latest
    needs: ci-env-check # Depends on env being okay
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - name: ðŸ”§ Install dependencies
        run: npm ci
      - name: ðŸŽ¨ Check code formatting with Prettier
        run: npx prettier --check .
      # 'npm run validate' for alias violations is removed, as it's in core-validation

  # Job 4: Security Audit (No change needed here from current)
  security-audit:
    name: ðŸ” Security Audit
    runs-on: ubuntu-latest
    needs: ci-env-check # Added dependency

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ”§ Install dependencies
        run: npm ci

      - name: ðŸ” Run security audit
        run: |
          echo "ðŸ” Running security audit..."
          npm audit --audit-level=moderate || true

          echo "ðŸ” Checking for high/critical vulnerabilities..."
          if npm audit --audit-level=high --parseable | grep -q .; then
            echo "âŒ High/critical security vulnerabilities found!"
            echo "Run 'npm audit fix' to resolve issues"
            npm audit --audit-level=high
            exit 1
          else
            echo "âœ… No critical security vulnerabilities found"
          fi

  # Job 5: Boundary Enforcement for PRs (No change needed here from current)
  boundary-enforcement:
    name: ðŸš¨ Boundary Enforcement (PRs) # Changed Name
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: ci-env-check # Added dependency

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for diff

      - name: ðŸ” Check changed files for boundary violations
        run: |
          echo "ðŸ” Checking changed files for boundary violations..."

          # Get list of changed files
          changed_files=$(git diff --name-only origin/main...HEAD)

          echo "ðŸ“ Changed files:"
          echo "$changed_files"

          # Check for forbidden patterns
          violations=0

          # Check if server files import from client/
          if echo "$changed_files" | grep -E "^server/" | xargs grep -l "from.*client/" 2>/dev/null; then
            echo "âŒ VIOLATION: Server files importing from client/"
            violations=$((violations + 1))
          fi

          # Check if client files import from server/
          if echo "$changed_files" | grep -E "^client/" | xargs grep -l "from.*server/" 2>/dev/null; then
            echo "âŒ VIOLATION: Client files importing from server/"
            violations=$((violations + 1))
          fi

          # Check if server files import vite config
          if echo "$changed_files" | grep -E "^server/" | xargs grep -l "vite\.config" 2>/dev/null; then
            echo "âŒ VIOLATION: Server files importing Vite config!"
            violations=$((violations + 1))
          fi

          # Check if shared/ files import from client/ or server/
          if echo "$changed_files" | grep -E "^shared/" | xargs grep -l "from.*\(client\|server\)/" 2>/dev/null; then
            echo "âŒ VIOLATION: Shared files importing from client/ or server/"
            violations=$((violations + 1))
          fi

          if [ $violations -gt 0 ]; then
            echo ""
            echo "ðŸš¨ $violations boundary violation(s) detected!"
            echo "ðŸ“– Please review CONTRIBUTING.md for boundary rules"
            # It seems 'npm run validate:fix' is the command for fixing these based on validate-everything.ts
            echo "ðŸ”§ Run 'npm run validate --fix' or relevant fix script locally"
            exit 1
          else
            echo "âœ… No boundary violations detected in changed files"
          fi

  deployment-readiness:
    name: ðŸš€ Deployment Readiness
    runs-on: ubuntu-latest
    # Depends on the primary validation jobs now
    needs: [core-validation, formatting-check, security-audit]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ”§ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Test build process
        run: |
          echo "ðŸ—ï¸ Testing build process..."
          npm run build || {
            echo "âŒ Build failed! Not ready for deployment"
            exit 1
          }
          echo "âœ… Build successful - ready for deployment"

      - name: ðŸ“Š Generate deployment summary
        run: |
          echo "## ðŸš€ Deployment Readiness Report" >> $GITHUB_STEP_SUMMARY
          # Adjust messages based on new job names if needed
          echo "âœ… **Core validations passed**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Formatting verified**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Security audit clean**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Build process successful**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **READY FOR DEPLOYMENT!**" >> $GITHUB_STEP_SUMMARY
