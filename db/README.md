# Degentalk™ Database (`db/`)

## Status: Reviewed – Awaiting Final Approval | 2025-06-02

## 1. Purpose & Role

The `db/` directory is central to data persistence and management for the Degentalk™ platform. It contains:

1.  **Schema Definitions:** The authoritative Drizzle ORM schemas that define the structure, relationships, and types for all database tables.
2.  **Database-Specific Files:** Configuration related to the PostgreSQL database environment.
3.  **(Potentially) Seeding Scripts & Utilities:** While many seed scripts are in the root `scripts/db/` directory, this `db/` folder might contain helpers or configurations directly tied to schema setup or specific database instances.

Its primary role is to be the source of truth for the database structure and to house files directly related to the PostgreSQL database or its schemas.

## 2. Structure & Key Components

Based on the project structure (`directory-tree.md`):

- **`db/schema/`**: This is the most critical subdirectory. It contains all Drizzle ORM TypeScript schema definitions, organized by domain.
  - Examples: `db/schema/user/users.ts`, `db/schema/forum/threads.ts`, `db/schema/economy/wallets.ts`.
  - An `index.ts` within `db/schema/` typically exports all schemas, making them easily importable by the server-side Drizzle client and Drizzle Kit for migrations.
- **`db/index.ts`**: Likely re-exports schemas or provides a central point for database-related imports for the server.
- **`db/README.md`**: This file, providing an overview of the `db/` directory.
  no
  **Note on Migrations:** Actual database migration files (SQL files generated by Drizzle Kit) are located in the project root `migrations/` directory (e.g., `migrations/postgres/`), not directly within `db/`.

## 3. Source of Truth References

- **Database Structure:** The TypeScript files within `db/schema/` are the absolute source of truth for the database table structures, columns, types, and relationships.
- **Drizzle ORM Configuration:** `drizzle.config.ts` (in the project root) configures Drizzle Kit, pointing it to these schema files for generating migrations.
- **Server Database Client:** `server/src/core/db.ts` (or similar) initializes the Drizzle ORM client that the server uses to interact with the database based on these schemas.

## 4. Architectural Principles & Conventions

- **Schema as Code:** Database schemas are defined programmatically using TypeScript and Drizzle ORM, enabling version control and type safety.
- **Domain-Driven Schema Organization:** Schemas in `db/schema/` are grouped by business domain (e.g., `user`, `forum`, `economy`), mirroring the server-side domain structure.
- **Single Source of Truth:** The `db/schema/` files are the definitive source for database structure. All database interactions and migrations are derived from them.
- **Migration-Based Changes:** Database structural changes must be made by modifying the schema files in `db/schema/`, then generating and applying migrations using Drizzle Kit (`npm run db:migrate` and `npm run db:migrate:apply`). Direct database alterations are discouraged.

## 5. Working with Schemas & Migrations

1.  **Modifying Schema:** Edit the relevant TypeScript files in `db/schema/` (e.g., add a column to `db/schema/user/users.ts`).
2.  **Generating Migrations:** Run `npm run db:migrate` from the project root. This will compare the current state of your schemas with the last migration snapshot and generate a new SQL migration file in `migrations/postgres/`.
3.  **Applying Migrations:** Run `npm run db:migrate:apply` from the project root. This executes the pending migration files against your configured database (defined by `DATABASE_URL` in `.env.local`).
4.  **Drizzle Studio (Optional):** Use `npm run db:studio` to open a GUI for browsing your database schema and data (works with your development database).

## 6. Database Environments

- **Development & Production:** Both environments use PostgreSQL.
- Connection details are managed via the `DATABASE_URL` environment variable in `.env.local`.

---

_This README provides an overview of the `db/` directory. For specific table details, refer to the schema files within `db/schema/`._
