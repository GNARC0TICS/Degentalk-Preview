# Degentalk Server

## Status: Reviewed â€“ Awaiting Final Approval | 2025-06-02

## 1. Purpose & Role

The `server/` directory houses the backend application for the Degentalk platform. It is responsible for handling API requests from the client, interacting with the database, managing business logic, user authentication, and real-time communication. Built with Node.js, Express.js, and TypeScript, it uses Drizzle ORM for database interactions with PostgreSQL.

## 2. Structure & Key Components

The server codebase follows a domain-driven design approach to organize its modules and services.

- **`server/index.ts`**: The main entry point for the backend application, responsible for initializing the Express app, setting up middleware, connecting to the database, and starting the server.
- **`server/src/app.ts`**: Configures the Express application, including mounting primary middleware, routes, and error handling.
- **`server/src/core/`**: Contains core backend functionalities:
  - `db.ts`: Drizzle ORM client setup and database connection.
  - `logger.ts`: Application-wide logging configuration.
  - `errors.ts`: Custom error classes and error handling utilities.
  - `middleware.ts`: General-purpose middleware not specific to a domain.
- **`server/src/domains/[domain-name]/`**: The heart of the backend, where each `[domain-name]` directory encapsulates all logic related to a specific business domain (e.g., `forum`, `wallet`, `admin`, `users`, `xp`). A typical domain directory includes:
  - `[domain].routes.ts`: Express router definitions for the domain's API endpoints.
  - `[domain].controller.ts`: Handles incoming requests, validates input (often using Zod schemas from `shared/validators/` or domain-specific validators), and calls service methods.
  - `[domain].service.ts`: Contains the core business logic, data manipulation, and interaction with the database (via Drizzle ORM) for the domain.
  - `[domain].validators.ts` (optional): Domain-specific Zod schemas for request validation if not covered by `shared/validators/`.
  - `[domain].types.ts` (optional): TypeScript type definitions specific to the domain.
- **`server/src/middleware/`**: Contains reusable Express middleware functions used across different domains or for global concerns (e.g., `auth.ts` for authentication, `validateRequest.ts` for Zod schema validation).
- **`server/src/utils/`**: General utility functions used across the server codebase.
- **`server/routes.ts`**: (May be deprecated or simplified) Historically, the main route registration file. Modern structure emphasizes domain-specific routes registered in `server/src/app.ts` or via a loader.
- **`server/config/`**: Configuration files, such as environment variable loading (`loadEnv.ts`).
- **`db/schema/` (Project Root)**: Contains all Drizzle ORM schema definitions, organized by domain. The server interacts with these schemas via the Drizzle client configured in `server/src/core/db.ts`.
- **`migrations/` (Project Root)**: Database migration files generated by Drizzle Kit.

## 3. Source of Truth References

- **Database Schemas:** `db/schema/` (project root) is the definitive source for all table structures and relationships.
- **API Endpoints:** Defined within each `server/src/domains/[domain-name]/[domain].routes.ts` file.
- **Business Logic:** Primarily located in `server/src/domains/[domain-name]/[domain].service.ts` files.
- **Shared Types & Validators:** `shared/types.ts` and `shared/validators/` for data structures and validation rules shared with the client.
- **Environment Configuration:** `env.local` (project root) and processed by `server/config/loadEnv.ts`.

## 4. Architectural Principles & Conventions

- **Domain-Driven Design (DDD):** Logic is organized into domains, promoting separation of concerns and modularity.
- **Service Layer:** Business logic is encapsulated within service files (`.service.ts`).
- **Controller Layer:** Controllers (`.controller.ts`) handle HTTP request/response and delegate to services.
- **ORM Usage:** Drizzle ORM is used for all database interactions, ensuring type safety and a fluent API.
- **Asynchronous Operations:** Extensive use of `async/await` for non-blocking I/O.
- **Error Handling:** Standardized error responses and centralized error handling.
- **Validation:** Zod schemas are used for robust request validation, typically in controllers or via middleware.
- **Type Safety:** TypeScript is used throughout to ensure code quality and reduce runtime errors.
- **Kebab-Case Naming:** Files and folders generally use kebab-case.
- **Path Aliases:** Utilize `@/` for server-side src, e.g. `@/core/db` or `@/domains/user/user.service`. (Verify specific aliases in `tsconfig.json`).

## 5. Status & Known Issues

- **Status:** The backend is actively developed and serves as the core API for the Degentalk platform.
- **Domain Migration:** The structure largely follows DDD, but some older routes or logic might exist outside strict domain encapsulation (e.g., in a global `server/routes.ts` if still heavily used).
- (TODO: Add any other known major issues, areas of active refactoring, or performance considerations specific to the server.)

## 6. Getting Started (Development)

- **Prerequisites:** Node.js, npm, PostgreSQL instance (local or remote).
- **Installation:** `npm install` in the project root directory.
- **Database Setup:**
  - Ensure PostgreSQL is running and accessible.
  - Configure `DATABASE_URL` in `.env.local`.
  - Apply migrations: `npm run db:migrate:apply` (from root).
  - Seed data (optional but recommended): `npm run seed:all` (from root).
- **Running the Backend:** `npm run dev` (from the project root directory). This will start the backend server (typically on port 5001, defined by `PORT` in `.env.local`) with hot reloading enabled via `tsx`.
- **Environment Variables:** Ensure `.env.local` is present in the project root with necessary backend configurations (database URL, API keys, etc.).

## 7. Key Dependencies

- **Express.js:** Web framework.
- **TypeScript:** Language for static typing.
- **Drizzle ORM:** PostgreSQL ORM.
- **Zod:** Schema validation.
- **tsx:** TypeScript execution and hot-reloading for development.
- **jsonwebtoken & bcrypt:** For authentication and password hashing (if implementing full auth).

---

_This README is intended to be a living document. Please update it as the server architecture or key components change._
