## Batch 3

### Security & Data-sanitisation

#### client/src/components/forum/PostCard.tsx ‚Üí `dangerouslySetInnerHTML`

##### üîç Issues
- Post content is injected directly without sanitisation; vulnerable to XSS if backend ever fails to sanitize.
- No fallback for empty `contentHtml` ‚Äì can render empty div and waste DOM nodes.

##### ‚úÖ Suggestions
- Pipe HTML through `dompurify` or `sanitize-html` at render time (**double encode** guard).
- Short-circuit render if string is falsy.

---

### Navigation Consistency & Configurability

#### HierarchicalZoneNav vs SidebarNavigation

##### üîç Issues
- `HierarchicalZoneNav` builds tree from `ForumStructureContext`; `SidebarNavigation` (legacy) still maps static `forumMap.config.ts` ‚Üí split sources.
- Both components own their own icon logic; inconsistent theming keys.

##### ‚úÖ Suggestions
- Create `@/navigation/forumNav.ts` exposing a **unified builder** returning tree meta; both components consume.
- Provide theme/icon override via context: `ForumThemeProvider`.
- Remove hard-coded `ZONE_THEMES` import; move into config file loaded from backend settings to make them **admin-configurable**.

---

### Scripts / Seeds Technical Debt

#### scripts/seed-dummy-threads.ts & seedForumsFromConfig.ts

##### üîç Issues
- Hard-coded numeric IDs for categories (e.g. `categoryId: 3`) ‚Äì breaks when DB re-seeded.
- Relies on insertion order assumptions (first zone ‚Üí id=1).

##### ‚úÖ Suggestions
- Resolve FK IDs dynamically using slug lookup queries before insert.
- Wrap inserts in transaction; rollback on failure.
- Add CLI flag `--wipe` to optionally truncate tables so script is idempotent.

---

### Migrations Safety Audit

##### Identified Files
- `migrations/0002_broken_viper.sql`
- `server/migrations/20250510_create_xp_adjustment_logs.ts` (extends forum threads for XP)

##### üîç Issues
- Uses `SERIAL` in raw SQL; Postgres 15+ recommends `GENERATED BY DEFAULT AS IDENTITY`.
- Two migrations drop intermediary table `forum_search_index` **without `IF EXISTS`** guard.
- No explicit `DOWN` migration in TypeScript migration files.

##### ‚úÖ Suggestions
1. Edit SQL migrations: replace
   ```sql
   id SERIAL PRIMARY KEY
   ```
   with
   ```sql
   id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
   ```
2. Add `IF EXISTS`/`IF NOT EXISTS` guards around `DROP`/`CREATE`.
3. Provide `down()` implementations in TS migration files. 